// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Management - Multi-tenant
model User {
  id       String  @id @default(cuid())
  email    String  @unique
  password String
  name     String
  role     Role    @default(USER)
  isActive Boolean @default(true)

  // Multi-tenant isolation
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  // Evolution API Instance per user
  evolutionInstance String? @unique

  // Evolution API credentials (encrypted)
  evolutionUrl    String? // Base URL Evolution API user
  evolutionApiKey String? // Stored encrypted
  instanceName    String? // Instance name

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  // Relations
  contacts         Contact[]
  campaigns        Campaign[]
  messageTemplates MessageTemplate[]
  channels         Channel[]
  messageLogs      MessageLog[]
  refreshTokens    RefreshToken[]

  @@map("users")
}

model Branch {
  id       String  @id @default(cuid())
  name     String
  code     String  @unique
  address  String?
  phone    String?
  isActive Boolean @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users     User[]
  contacts  Contact[]
  campaigns Campaign[]
  analytics Analytics[]
  settings  Setting[]

  @@map("branches")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
  VIEWER
}

// Contact Management
model Contact {
  id    String  @id @default(cuid())
  name  String?
  phone String
  email String?

  // Auto-mapping fields
  mappedPhone String?
  isVerified  Boolean @default(false)
  isBlocked   Boolean @default(false)

  // Auto-detect new contacts
  autoDetected Boolean   @default(false)
  detectedAt   DateTime?

  // Multi-tenant isolation
  userId   String
  user     User   @relation(fields: [userId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  // Contact groups/segments
  segments ContactSegment[]

  // Message history
  messages Message[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, phone])
  @@map("contacts")
}

// Campaign Management
model Campaign {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Campaign status
  status         CampaignStatus @default(DRAFT)
  totalMessages  Int            @default(0)
  sentMessages   Int            @default(0)
  failedMessages Int            @default(0)

  // Campaign settings
  startAt DateTime?
  endAt   DateTime?

  // Delay settings for anti-ban protection
  minDelay Int @default(5000) // 5 seconds
  maxDelay Int @default(30000) // 30 seconds

  // Multi-tenant isolation
  userId   String
  user     User   @relation(fields: [userId], references: [id])
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  // Relations
  messages  Message[]
  jobQueues JobQueue[]
  templates MessageTemplate[]

  @@map("campaigns")
}

enum CampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  CANCELLED
}

// Message Templates
model MessageTemplate {
  id        String @id @default(cuid())
  name      String
  content   String
  variables Json? // Template variables like {{name}}, {{phone}}

  // Multi-tenant isolation
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Relation to Campaign
  campaignId String?
  campaign   Campaign? @relation(fields: [campaignId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("message_templates")
}

// Contact Segments for targeted campaigns
model Segment {
  id             String  @id @default(cuid())
  name           String
  description    String?
  filterCriteria Json // JSON with filtering rules

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contacts ContactSegment[]

  @@map("segments")
}

model ContactSegment {
  id        String  @id @default(cuid())
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])
  segmentId String
  segment   Segment @relation(fields: [segmentId], references: [id])

  createdAt DateTime @default(now())

  @@unique([contactId, segmentId])
  @@map("contact_segments")
}

// Messages and Queue System
model Message {
  id String @id @default(cuid())

  // Message content
  content   String
  variables Json? // Resolved variables for this message

  // Message status
  status      MessageStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?

  // Error handling
  errorMessage String?
  retryCount   Int     @default(0)
  maxRetries   Int     @default(3)

  // Queue management
  jobId String? // BullMQ job ID

  // Multi-tenant isolation
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])
  contactId  String
  contact    Contact  @relation(fields: [contactId], references: [id])

  // Channel info
  channelId String
  channel   Channel @relation(fields: [channelId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  logs MessageLog[]

  @@map("messages")
}

enum MessageStatus {
  PENDING
  QUEUED
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
  CANCELLED
}

// Queue Jobs Management (Redis + BullMQ)
model JobQueue {
  id    String @id @default(cuid())
  jobId String @unique // BullMQ job ID

  // Job details
  name     String
  type     JobType
  priority Int     @default(0)
  data     Json // Job data

  // Job status
  status   JobStatus @default(WAITING)
  progress Int       @default(0)

  // Scheduling
  scheduledAt DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?
  failedAt    DateTime?

  // Retry handling
  attempts    Int @default(0)
  maxAttempts Int @default(3)

  // Multi-tenant isolation
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("job_queues")
}

enum JobType {
  SEND_MESSAGE
  SYNC_CONTACTS
  CHECK_DELIVERY
  CLEANUP
  RETRY_MESSAGE
}

enum JobStatus {
  WAITING
  DELAYED
  ACTIVE
  COMPLETED
  FAILED
  PAUSED
}

// Channel Management (WhatsApp, Telegram, TikTok)
model Channel {
  id       String      @id @default(cuid())
  name     String
  type     ChannelType
  isActive Boolean     @default(true)

  // Channel configuration
  config      Json // Channel-specific settings
  credentials Json? // Encrypted credentials

  // Status
  status          ChannelStatus @default(DISCONNECTED)
  lastConnectedAt DateTime?

  // Multi-tenant isolation
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Relations
  messages Message[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("channels")
}

enum ChannelType {
  WHATSAPP
  TELEGRAM
  TIKTOK
  EMAIL
  SMS
}

enum ChannelStatus {
  DISCONNECTED
  CONNECTING
  CONNECTED
  ERROR
  RATE_LIMITED
}

// Analytics and Reporting
model Analytics {
  id   String   @id @default(cuid())
  date DateTime @db.Date

  // Daily metrics
  messagesSent      Int @default(0)
  messagesDelivered Int @default(0)
  messagesRead      Int @default(0)
  messagesFailed    Int @default(0)

  // Revenue metrics (optional)
  revenue Decimal? @db.Decimal(10, 2)

  // Multi-tenant isolation
  branchId String
  branch   Branch @relation(fields: [branchId], references: [id])

  @@unique([date, branchId])
  @@map("analytics")
}

// System Settings
model Setting {
  id          String  @id @default(cuid())
  key         String  @unique
  value       Json
  description String?
  isPublic    Boolean @default(false)

  // Multi-tenant isolation
  branchId String?
  branch   Branch? @relation(fields: [branchId], references: [id])

  updatedAt DateTime @updatedAt

  @@map("settings")
}

// Message Log for audit trail
model MessageLog {
  id String @id @default(cuid())

  // Message details
  number   String
  status   String // sent, failed, delivered, read
  response Json? // Raw API response

  // Multi-tenant isolation
  tenantId String
  tenant   User   @relation(fields: [tenantId], references: [id])

  // Linked message (optional)
  itemId  String? // Reference to Message or other message ID
  message Message? @relation(fields: [itemId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())

  @@index([tenantId])
  @@map("message_logs")
}

// Refresh Tokens for JWT auth
model RefreshToken {
  id        String @id @default(cuid())
  tokenHash String @unique

  // Multi-tenant isolation
  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  expiresAt DateTime

  @@index([userId])
  @@map("refresh_tokens")
}
